{% extends 'main/base.html' %}
{% block title %}Каталог книг{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Каталог книг</h2>

    {% if user.is_authenticated %}
    <div class="alert alert-info">
        Вы вошли как:
        <strong>{{ user.first_name }} {{ user.last_name }}</strong>
        <span class="badge bg-secondary">роль: {{ user.role }}</span>
    </div>
    {% endif %}

    <table class="table table-striped table-bordered table-hover">
        <thead class="table-dark">
        <tr>
            <th>Название</th>
            <th>Автор</th>
            <th>Год</th>
            <th>Категория</th>
            <th>Доступно</th>
            <th>Действия</th>
        </tr>
        </thead>
        <tbody>
        {% for book in books %}
        <tr>
            <td><a href="{% url 'book_detail' book.id %}">{{ book.title }}</a></td>
            <td>{{ book.author }}</td>
            <td>{{ book.year }}</td>
            <td>{{ book.category.name }}</td>
            <td>{{ book.copies_available }} / {{ book.copies_total }}</td>
            <td>
                {# Читать — всем авторизованным, если есть файл/ссылка #}
                {% if book.file or book.file_url %}
                {% if user.is_authenticated %}
                <a href="{% url 'read_book' book.id %}" class="btn btn-sm btn-success me-2 mb-2">Читать</a>
                {% else %}
                <a href="{% url 'login' %}" class="btn btn-sm btn-outline-success me-2 mb-2">Читать (войти)</a>
                {% endif %}
                {% else %}
                <span class="badge bg-secondary me-2 mb-2">Нет файла/ссылки</span>
                {% endif %}

                {# Раздел прав делаем без скобок, через вложенные if #}
                {% if user.is_authenticated %}
                {% if user.role == 'admin' or user.role == 'librarian' %}
                <a href="{% url 'edit_book' book.id %}" class="btn btn-sm btn-primary me-2 mb-2">Редактировать</a>
                {% endif %}
                {% if user.role == 'admin' %}
                <a href="{% url 'delete_book' book.id %}" class="btn btn-sm btn-danger mb-2"
                   onclick="return confirm('Удалить эту книгу?');">Удалить</a>
                {% endif %}
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" class="text-center text-muted">Нет доступных книг.</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>

    {% if user.is_authenticated %}
    {% if user.role == 'admin' or user.role == 'librarian' %}
    <a href="{% url 'add_book' %}" class="btn btn-success mt-3">➕ Добавить книгу</a>
    {% endif %}
    {% endif %}
</div>
{% endblock %}
